---
title: "Ntpd和Ntpdate的区别"
date: 2019-03-10T19:20:11+08:00
draft: false
tags: ["ntp", "ntpd", "ntpdate", "时间同步"]
categories: ["devops"]
keywords: []
---

> 借用某博客的一句话：我觉得使用 ntpdate 代替 ntpd 的人都是应该被裁掉的

## 背景

研发查看 Mongo 同步时间时发现部分机器时间不准确，SRE 校准之后线上出现告警，Mongo 数据库发生了主从切换，排查之后发现机器并无异常，原因是因为同步机器时间导致 Mongo 内部时间混乱，然后重新选举主节点。

## ntpdate

ntpdate 是一个时间同步命令，以远端时间为准，采用野蛮式、跃进式的方式调整服务器时间，会造成时间跳跃。

## ntpd

- ntpd 是一个时间同步服务，采用柔性时间调整策略，让时间缓慢地向正确时间靠拢，让时间的变化和调整尽量减少对业务的影响。
- ntpd 不会盲目信任远端时间。如果本地时间和远端时间超过 panic 阈值（默认 1000s），ntpd 会停止时间同步。
- ntpd 通过多次收发包选择权威稳定的时间源，算出双方间的网络延迟，然后才会采信新的远端时钟进行时间同步。
- ntpd 在和时间服务器的同步过程中，会把 BIOS 计时器的振荡频率偏差，或者说 Local Clock 的自然漂移(drift)记录下来。这样即使网络有问题，本机仍然能维持一个相当精确的走时。

## 建议

- 默认情况下启动 ntpd 服务来同步时间
- 若本地时间和远端时间相差过大，ntpd 无法启动，则应该先使用 ntpdate 同步（提前确定是否影响业务）
- ntpd 存在主动退出的风险，应该监控起来
